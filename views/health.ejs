<!-- ê³ ê¸‰ì›¹í”„ë¡œê·¸ë˜ë° ê¸°ë§í”„ë¡œì íŠ¸ ì´ì„±ì€ 60212770 -->
<!-- views/health.ejs -->
<!-- ìš´ë™ ê¸°ë¡ í˜ì´ì§€ + ìš´ë™ ë²„íŠ¼ ì„ íƒ + ì¹¼ë¡œë¦¬ ê³„ì‚° -->

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title><%= title %></title>
  <link rel="stylesheet" href="/frontUser.css" />
</head>
<body>
  <header><%- include('./header', { session: session }); %></header>

  <h2>ìš´ë™ ê¸°ë¡</h2>

  <!-- ğŸ”¹ ì˜¤ëŠ˜ì˜ ì¹¼ë¡œë¦¬ í˜„í™© -->
  <section id="calorieSection" style="border:1px solid #aaa; padding:10px; margin-bottom:15px;">
    <h3>ì˜¤ëŠ˜ì˜ ì¹¼ë¡œë¦¬ í˜„í™©</h3>
    <p id="calorieMessage">ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤...</p>
    <ul id="calorieDetail" style="display:none; list-style:none; padding-left:0;">
      <li>ê¸°ì´ˆëŒ€ì‚¬ëŸ‰ (BMR): <span id="bmrSpan"></span> kcal/ì¼</li>
      <li>ê¸°ì´ˆëŒ€ì‚¬ ê¸°ì¤€ í˜„ì¬ê¹Œì§€ ì†Œëª¨ ì¹¼ë¡œë¦¬: <span id="baseBurnedSpan"></span> kcal</li>
      <li>ìš´ë™ìœ¼ë¡œ ì¶”ê°€ ì†Œëª¨ ì¹¼ë¡œë¦¬: <span id="exerciseBurnedSpan"></span> kcal</li>
      <li>ì´ ì†Œëª¨ ì¹¼ë¡œë¦¬: <span id="burnedSpan"></span> kcal</li>
      <li>ì˜¤ëŠ˜ ì„­ì·¨ ì¹¼ë¡œë¦¬ (ì‹ë‹¨ ê¸°ì¤€): <span id="intakeSpan"></span> kcal</li>
      <li>ìˆœ ì†Œëª¨ ì¹¼ë¡œë¦¬ (ì†Œëª¨ - ì„­ì·¨): <span id="netSpan"></span> kcal</li>
    </ul>
    <button type="button" id="calorieRefreshBtn">ë‹¤ì‹œ ê³„ì‚°</button>
    <p style="font-size: 0.9em; color: #555; margin-top:5px;">
      * íšŒì› ì •ë³´ì˜ ë‚˜ì´Â·ì„±ë³„Â·ì²´ì¤‘Â·ì‹ ì¥ì„ ê¸°ë°˜ìœ¼ë¡œ ê¸°ì´ˆëŒ€ì‚¬ëŸ‰ì„ ê³„ì‚°í•˜ê³ ,<br/>
      * ì„ íƒí•œ ìš´ë™ì˜ METsì™€ ìš´ë™ ì‹œê°„ìœ¼ë¡œ ì¶”ê°€ ì†Œëª¨ ì¹¼ë¡œë¦¬ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
    </p>
  </section>

  <!-- ğŸ”¹ ìš´ë™ ê¸°ë¡ ë“±ë¡ -->
  <form method="post" action="/health">
    <fieldset style="margin-bottom:10px;">
      <legend>ìš´ë™ ì„ íƒ</legend>
      <p style="margin-bottom:5px;">ìš´ë™ ë²„íŠ¼ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•œ ë’¤, ì‹œê°„ ì„ íƒ í›„ "ì¶”ê°€" ë²„íŠ¼ìœ¼ë¡œ ì—¬ëŸ¬ ìš´ë™ì„ ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

      <!-- ìš´ë™ ì„ íƒìš© ë²„íŠ¼ë“¤ -->
      <div id="exerciseButtonGroup" style="display:flex; flex-wrap:wrap; gap:8px;">
        <% if (exercises && exercises.length > 0) { %>
          <% exercises.forEach(ex => { %>
            <button
              type="button"
              class="exerciseBtn"
              data-id="<%= ex.id %>"
              data-name="<%= ex.exercise_name %>"
              style="padding:6px 10px; border-radius:4px; border:1px solid #999; background:#f6f6f6; cursor:pointer;"
            >
              <%= ex.exercise_name %>
            </button>
          <% }) %>
        <% } else { %>
          <span>ë“±ë¡ëœ ìš´ë™ì´ ì—†ìŠµë‹ˆë‹¤. (Exercise í…Œì´ë¸”ì„ ë¨¼ì € ì±„ì›Œì£¼ì„¸ìš”.)</span>
        <% } %>
      </div>

      <!-- í˜„ì¬ ì„ íƒëœ ìš´ë™ ì •ë³´ë¥¼ ì €ì¥ -->
      <input type="hidden" id="exerciseIdInput" />
      <input type="hidden" id="exerciseTypeInput" />
      <p id="selectedExerciseText" style="margin-top:8px; color:#444;">
        ì„ íƒëœ ìš´ë™: ì—†ìŒ
      </p>

      <!-- í˜„ì¬ ì„ íƒëœ ìš´ë™ + ì‹œê°„ìœ¼ë¡œ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ -->
      <div style="margin-top:8px;">
        <label>ìš´ë™ ì‹œê°„ ì„ íƒ</label>
        <select id="durationSelectForAdd" style="margin-left:6px;">
          <option value="">ì‹œê°„ ì„ íƒ</option>
          <option value="30ë¶„ ì´í•˜">30ë¶„ ì´í•˜</option>
          <option value="30ë¶„ ~ 1ì‹œê°„">30ë¶„ ~ 1ì‹œê°„</option>
          <option value="1ì‹œê°„ ~ 1ì‹œê°„ 30ë¶„">1ì‹œê°„ ~ 1ì‹œê°„ 30ë¶„</option>
          <option value="1ì‹œê°„ 30ë¶„ ì´ìƒ">1ì‹œê°„ 30ë¶„ ì´ìƒ</option>
        </select>
        <button type="button" id="addExerciseItemBtn" style="margin-left:6px;">
          í˜„ì¬ ìš´ë™ ì¶”ê°€
        </button>
      </div>

      <!-- ì‹¤ì œë¡œ ë“±ë¡ë  ì—¬ëŸ¬ ìš´ë™ ë¦¬ìŠ¤íŠ¸ -->
      <div style="margin-top:10px;">
        <p style="margin-bottom:4px;">ì´ë²ˆ ê¸°ë¡ì— í¬í•¨ë  ìš´ë™ ëª©ë¡</p>
        <ul id="selectedExerciseList" style="list-style:none; padding-left:0; margin:0;"></ul>
        <p style="font-size:0.85em; color:#666; margin-top:4px;">
          * ì•„ë¬´ ê²ƒë„ ì¶”ê°€í•˜ì§€ ì•Šìœ¼ë©´, "í˜„ì¬ ì„ íƒëœ ìš´ë™ + ì•„ë˜ì—ì„œ ê³ ë¥¸ ì‹œê°„" 1ê°œë§Œ ë“±ë¡ë©ë‹ˆë‹¤.
        </p>
      </div>
    </fieldset>

    <p>
      <label>ì„¸ë¶€ ì‚¬í•­</label>
      <input
        type="text"
        name="details"
        placeholder="ìš´ë™ ë¶€ìœ„, ì„¸íŠ¸ ìˆ˜ ë“± (ì„ íƒ)"
        style="width:60%;"
      />
    </p>

    <!-- ì´ select ëŠ” 'ë‹¨ì¼ ìš´ë™ë§Œ ë„£ì„ ë•Œ' ë°±ì—…ìš© -->
    <p>
      <label>ìš´ë™ ì‹œê°„ (ë‹¨ì¼ ë“±ë¡ìš© ë°±ì—…)</label>
      <select name="duration" id="singleDurationSelect">
        <option value="">ì‹œê°„ ì„ íƒ</option>
        <option value="30ë¶„ ì´í•˜">30ë¶„ ì´í•˜</option>
        <option value="30ë¶„ ~ 1ì‹œê°„">30ë¶„ ~ 1ì‹œê°„</option>
        <option value="1ì‹œê°„ ~ 1ì‹œê°„ 30ë¶„">1ì‹œê°„ ~ 1ì‹œê°„ 30ë¶„</option>
        <option value="1ì‹œê°„ 30ë¶„ ì´ìƒ">1ì‹œê°„ 30ë¶„ ì´ìƒ</option>
      </select>
    </p>

    <button type="submit">ìš´ë™ ê¸°ë¡ ë“±ë¡</button>
  </form>

  <hr />

  <h3>ë‚´ ìš´ë™ ê¸°ë¡ ëª©ë¡</h3>

  <div id="healthList">
    <% if (records && records.length > 0) { %>
      <% records.forEach(r => { %>
        <div
          data-id="<%= r.id %>"
          data-exercise-type="<%= r.exercise_type %>"
          data-duration="<%= r.duration || '' %>"
          data-details="<%= r.details || '' %>"
          style="border: 1px solid #ccc; margin: 10px 0; padding: 10px;"
        >
          <!-- ì´ ê¸°ë¡ì— ì—°ê²°ëœ ìš´ë™ ëª©ë¡ì„ JSON ìœ¼ë¡œ ë³´ê´€ -->
          <input
            type="hidden"
            class="exerciseItemsData"
            value='<%- JSON.stringify(r.exerciseItems || []) %>'
          />

          <p>[<%= r.date %>] <strong><%= r.exercise_type %></strong></p>
          <p>ì„¸ë¶€ ì‚¬í•­: <%= r.details || '-' %></p>
          <p>ìš´ë™ ì‹œê°„: <%= r.duration || '-' %></p>

          <% if (r.exerciseItems && r.exerciseItems.length > 0) { %>
            <p>ìš´ë™ë³„ ì†Œëª¨ ì¹¼ë¡œë¦¬:</p>
            <ul style="margin-top:0;">
              <% r.exerciseItems.forEach(item => { %>
                <li>
                  <%= item.name || 'ìš´ë™' %> -
                  <%= item.minutes %>ë¶„,
                  ì•½ <%= Math.round(item.calorie || 0) %> kcal ì†Œëª¨
                </li>
              <% }) %>
            </ul>
            <p><strong>í•´ë‹¹ ê¸°ë¡ì˜ ì´ ìš´ë™ ì†Œëª¨ ì¹¼ë¡œë¦¬: <%= Math.round(r.totalExerciseCalorie || 0) %> kcal</strong></p>
          <% } %>

          <!-- ìš´ë™ ê¸°ë¡ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ -->
          <button type="button" class="editBtn">ìˆ˜ì •</button>
          <button type="button" class="deleteBtn">ì‚­ì œ</button>

          <hr />

          <!-- ëŒ“ê¸€ ëª©ë¡ -->
          <h4>ëŒ“ê¸€</h4>
          <% if (r.comments && r.comments.length > 0) { %>
            <% r.comments.forEach(c => { %>
              <p
                data-comment-id="<%= c.id %>"
                data-health-id="<%= r.id %>"
                style="margin: 4px 0;"
              >
                - [<%= c.date %>]
                <strong><%= c.user %></strong> :
                <span class="commentText"><%= c.comment %></span>
                <!-- ëŒ“ê¸€ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ -->
                <button type="button" class="commentEditBtn" style="margin-left: 8px;">ëŒ“ê¸€ ìˆ˜ì •</button>
                <button type="button" class="commentDeleteBtn">ëŒ“ê¸€ ì‚­ì œ</button>
              </p>
            <% }) %>
          <% } else { %>
            <p>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          <% } %>

          <!-- ëŒ“ê¸€ ì…ë ¥ í¼ -->
          <form method="post" action="/health/<%= r.id %>/comments">
            <input type="text" name="comment" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:70%;" required />
            <button type="submit">ëŒ“ê¸€ ì‘ì„±</button>
          </form>
        </div>
      <% }) %>
    <% } else { %>
      <p>ë“±ë¡ëœ ìš´ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    <% } %>
  </div>

  <script>
    // ===== ìš´ë™ ë²„íŠ¼ ì„ íƒ ì²˜ë¦¬ =====
    const exerciseButtons = document.querySelectorAll('.exerciseBtn');
    const exerciseIdInput = document.getElementById('exerciseIdInput');
    const exerciseTypeInput = document.getElementById('exerciseTypeInput');
    const selectedText = document.getElementById('selectedExerciseText');

    exerciseButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        // ëª¨ë“  ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
        exerciseButtons.forEach(b => {
          b.style.backgroundColor = '#f6f6f6';
          b.style.color = '#000';
        });

        // ì„ íƒëœ ë²„íŠ¼ ê°•ì¡°
        btn.style.backgroundColor = '#007bff';
        btn.style.color = '#fff';

        // hidden + í‘œì‹œ í…ìŠ¤íŠ¸ ê°±ì‹ 
        exerciseIdInput.value = btn.dataset.id;
        exerciseTypeInput.value = btn.dataset.name;
        selectedText.textContent = 'ì„ íƒëœ ìš´ë™: ' + btn.dataset.name;
      });
    });

    // ===== ë“±ë¡ í¼ì—ì„œ ì—¬ëŸ¬ ìš´ë™ ì¶”ê°€/ì‚­ì œ ì²˜ë¦¬ =====
    const addExerciseItemBtn   = document.getElementById('addExerciseItemBtn');
    const durationSelectForAdd = document.getElementById('durationSelectForAdd');
    const selectedExerciseList = document.getElementById('selectedExerciseList');
    const singleDurationSelect = document.getElementById('singleDurationSelect');
    const healthForm           = document.querySelector('form[action="/health"]');

    // li 1ê°œ ìƒì„± + hidden input ë‘ ê°œ(ë°°ì—´ìš©) ìƒì„±
    function createExerciseLi(exId, exName, durLabel) {
      const li = document.createElement('li');
      li.style.marginBottom = '4px';
      li.dataset.exerciseId = exId;
      li.dataset.duration   = durLabel;
      li.textContent        = exName + ' - ' + durLabel;

      const removeBtn = document.createElement('button');
      removeBtn.type  = 'button';
      removeBtn.textContent = 'ì‚­ì œ';
      removeBtn.style.marginLeft = '8px';
      removeBtn.addEventListener('click', () => {
        li.remove();
      });

      const exInput = document.createElement('input');
      exInput.type  = 'hidden';
      exInput.name  = 'exerciseIds';
      exInput.value = exId;

      const durInput = document.createElement('input');
      durInput.type  = 'hidden';
      durInput.name  = 'durations';
      durInput.value = durLabel;

      li.appendChild(removeBtn);
      li.appendChild(exInput);
      li.appendChild(durInput);

      return li;
    }

    if (addExerciseItemBtn && durationSelectForAdd && selectedExerciseList && healthForm) {
      // í˜„ì¬ ì„ íƒëœ ìš´ë™ + ì‹œê°„ â†’ ëª©ë¡ì— ì¶”ê°€
      addExerciseItemBtn.addEventListener('click', () => {
        const exId    = exerciseIdInput.value;
        const exName  = exerciseTypeInput.value;
        const durLabel = durationSelectForAdd.value;

        if (!exId) {
          alert('ë¨¼ì € ìš´ë™ ë²„íŠ¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        if (!durLabel) {
          alert('ìš´ë™ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        const li = createExerciseLi(exId, exName, durLabel);
        selectedExerciseList.appendChild(li);

        // ì¶”ê°€ í›„ ì‹œê°„ ì„ íƒ ì´ˆê¸°í™”
        durationSelectForAdd.value = '';
      });

      // í¼ submit ì‹œ, ì—¬ëŸ¬ìš´ë™/ë‹¨ì¼ìš´ë™ì— ë§ê²Œ hidden í•„ë“œ ì •ë¦¬
      healthForm.addEventListener('submit', (e) => {
        const hasMultiItems = selectedExerciseList.querySelector('li') !== null;

        if (hasMultiItems) {
          // ì—¬ëŸ¬ ìš´ë™ ëª¨ë“œ: ë‹¨ì¼ìš© duration ì€ ì„œë²„ì— ë³´ë‚´ì§€ ì•Šë„ë¡ name ì œê±°
          if (singleDurationSelect) {
            singleDurationSelect.name = '';
          }
        } else {
          // ì—¬ëŸ¬ìš´ë™ì„ í•˜ë‚˜ë„ ì¶”ê°€ ì•ˆ í–ˆìœ¼ë©´: ë‹¨ì¼ ìš´ë™ 1ê°œë¼ë„ ìˆì–´ì•¼ í•¨
          const exId    = exerciseIdInput.value;
          const exName  = exerciseTypeInput.value;
          const durLabel = singleDurationSelect ? singleDurationSelect.value : '';

          if (!exId || !durLabel) {
            alert('ìš´ë™ê³¼ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            e.preventDefault();
            return;
          }

          const li = createExerciseLi(exId, exName, durLabel);
          selectedExerciseList.appendChild(li);
          // ë‹¨ì¼ ëª¨ë“œì—ì„œë„ duration í•„ë“œëŠ” êµ³ì´ ì„œë²„ë¡œ ì•ˆ ë³´ë‚´ë„ ë˜ë¯€ë¡œ name ì œê±°
          if (singleDurationSelect) {
            singleDurationSelect.name = '';
          }
        }
      });
    }

    // ===== ì˜¤ëŠ˜ ì¹¼ë¡œë¦¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸° =====
    async function fetchCalorie() {
      const msgEl    = document.getElementById('calorieMessage');
      const detailEl = document.getElementById('calorieDetail');

      try {
        const res = await fetch('/health/calorie');
        if (!res.ok) throw new Error('response not ok');
        const data = await res.json();

        if (!data.bmr) {
          msgEl.textContent = data.message || 'íšŒì› ì •ë³´(ë‚˜ì´, ì„±ë³„, ì²´ì¤‘, ì‹ ì¥)ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.';
          detailEl.style.display = 'none';
          return;
        }

        msgEl.textContent = `ì˜¤ëŠ˜ ë‚ ì§œ (${data.date}) ê¸°ì¤€ ì¹¼ë¡œë¦¬ ì •ë³´ì…ë‹ˆë‹¤.`;
        detailEl.style.display = 'block';

        document.getElementById('bmrSpan').textContent            = data.bmr;
        document.getElementById('baseBurnedSpan').textContent     = data.baseBurned;
        document.getElementById('exerciseBurnedSpan').textContent = data.exerciseBurned;
        document.getElementById('burnedSpan').textContent         = data.burned;
        document.getElementById('intakeSpan').textContent         = data.intake;
        document.getElementById('netSpan').textContent            = data.net;
      } catch (err) {
        console.error(err);
        msgEl.textContent = 'ì¹¼ë¡œë¦¬ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
        detailEl.style.display = 'none';
      }
    }

    const calorieRefreshBtn = document.getElementById('calorieRefreshBtn');
    if (calorieRefreshBtn) {
      calorieRefreshBtn.addEventListener('click', fetchCalorie);
      fetchCalorie();
      setInterval(fetchCalorie, 10 * 60 * 1000);
    }

    // ===== ìœ í‹¸: ë¶„ â†’ duration ë ˆì´ë¸” =====
    function minutesToDurationLabel(minutes) {
      const m = Number(minutes) || 0;
      if (m <= 30) return '30ë¶„ ì´í•˜';
      if (m <= 60) return '30ë¶„ ~ 1ì‹œê°„';
      if (m <= 90) return '1ì‹œê°„ ~ 1ì‹œê°„ 30ë¶„';
      return '1ì‹œê°„ 30ë¶„ ì´ìƒ';
    }

    // ë“±ë¡ í¼ì˜ duration select (ì˜µì…˜ ì¬ì‚¬ìš©)
    const baseDurationSelect = document.getElementById('singleDurationSelect');

    // ìš´ë™ ë²„íŠ¼ ëª©ë¡ â†’ ìˆ˜ì • ëª¨ë‹¬ì—ì„œ ìš´ë™ select ì˜µì…˜ìœ¼ë¡œ ì‚¬ìš©
    const exerciseList = Array.from(document.querySelectorAll('.exerciseBtn')).map(btn => ({
      id: btn.dataset.id,
      name: btn.dataset.name,
    }));

    // ===== ìš´ë™ ê¸°ë¡ ìˆ˜ì • (ì—¬ëŸ¬ ìš´ë™) =====
    document.querySelectorAll('#healthList .editBtn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const div = btn.closest('div[data-id]');
        const id = div.dataset.id;
        const currentDetails = div.dataset.details || '';

        // ê¸°ì¡´ exerciseItems JSON íŒŒì‹±
        let exerciseItems = [];
        const hiddenInput = div.querySelector('.exerciseItemsData');
        if (hiddenInput && hiddenInput.value) {
          try {
            exerciseItems = JSON.parse(hiddenInput.value);
          } catch (err) {
            console.error('exerciseItems JSON parse error', err);
          }
        }

        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
          <div class="edit-health-modal-overlay"
               style="
                 position: fixed;
                 inset: 0;
                 background: rgba(0,0,0,0.4);
                 display: flex;
                 align-items: center;
                 justify-content: center;
                 z-index: 9999;
               ">
            <div class="edit-health-modal"
                 style="
                   background: #fff;
                   padding: 16px;
                   border-radius: 8px;
                   width: 90%;
                   max-width: 380px;
                   box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                   font-size: 14px;
                 ">
              <h3 style="margin-top: 0; margin-bottom: 12px;">ìš´ë™ ê¸°ë¡ ìˆ˜ì •</h3>

              <div style="margin-bottom: 8px;">
                <label style="display:block; margin-bottom:4px;">ìš´ë™ ì„ íƒ</label>
                <select class="edit-exercise-select" style="width:100%; padding:4px 8px;"></select>
              </div>

              <div style="margin-bottom: 8px;">
                <label style="display:block; margin-bottom:4px;">ìš´ë™ ì‹œê°„</label>
                <select class="edit-duration-select" style="width:100%; padding:4px 8px;"></select>
              </div>

              <div style="margin-bottom: 8px;">
                <button type="button" class="edit-add-btn" style="padding:4px 8px;">í˜„ì¬ ì„ íƒ ìš´ë™ ì¶”ê°€</button>
              </div>

              <div style="margin-bottom: 8px;">
                <p style="margin:4px 0;">ì´ ê¸°ë¡ì— í¬í•¨ë  ìš´ë™ ëª©ë¡</p>
                <ul class="edit-selected-exercise-list" style="list-style:none; padding-left:0; margin:0;"></ul>
              </div>

              <div style="margin-bottom: 12px;">
                <label style="display:block; margin-bottom:4px;">ì„¸ë¶€ ì‚¬í•­</label>
                <textarea class="edit-details-textarea"
                          rows="3"
                          style="width:100%; padding:4px 8px; resize: vertical;"></textarea>
              </div>

              <div style="text-align: right;">
                <button type="button" class="cancelEditBtn"
                        style="margin-right: 8px;">ì·¨ì†Œ</button>
                <button type="button" class="saveEditBtn">ì €ì¥</button>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(wrapper);

        const overlay         = wrapper.querySelector('.edit-health-modal-overlay');
        const modal           = wrapper.querySelector('.edit-health-modal');
        const exerciseSelect  = modal.querySelector('.edit-exercise-select');
        const durationSelect  = modal.querySelector('.edit-duration-select');
        const listEl          = modal.querySelector('.edit-selected-exercise-list');
        const detailsTextarea = modal.querySelector('.edit-details-textarea');
        const addBtn          = modal.querySelector('.edit-add-btn');
        const saveBtn         = modal.querySelector('.saveEditBtn');
        const cancelBtn       = modal.querySelector('.cancelEditBtn');

        // ìš´ë™ select ì˜µì…˜ ì±„ìš°ê¸°
        let exerciseOptionsHtml = '<option value="">ìš´ë™ ì„ íƒ</option>';
        if (exerciseList.length > 0) {
          exerciseList.forEach(ex => {
            exerciseOptionsHtml += `<option value="${ex.id}">${ex.name}</option>`;
          });
        }
        exerciseSelect.innerHTML = exerciseOptionsHtml;

        // duration select ì˜µì…˜ ì±„ìš°ê¸° (ë“±ë¡ í¼ì˜ ê²ƒì„ ë³µì‚¬)
        if (baseDurationSelect) {
          durationSelect.innerHTML = baseDurationSelect.innerHTML;
        } else {
          durationSelect.innerHTML = `
            <option value="">ì‹œê°„ ì„ íƒ</option>
            <option value="30ë¶„ ì´í•˜">30ë¶„ ì´í•˜</option>
            <option value="30ë¶„ ~ 1ì‹œê°„">30ë¶„ ~ 1ì‹œê°„</option>
            <option value="1ì‹œê°„ ~ 1ì‹œê°„ 30ë¶„">1ì‹œê°„ ~ 1ì‹œê°„ 30ë¶„</option>
            <option value="1ì‹œê°„ 30ë¶„ ì´ìƒ">1ì‹œê°„ 30ë¶„ ì´ìƒ</option>
          `;
        }

        // ìˆ˜ì •ìš© li ìƒì„± í—¬í¼
        function createEditExerciseLi(exName, exId, durLabel) {
          const li = document.createElement('li');
          li.style.marginBottom = '4px';
          li.dataset.exerciseId = exId;
          li.dataset.duration   = durLabel;
          li.textContent        = exName + ' - ' + durLabel;

          const removeBtn = document.createElement('button');
          removeBtn.type  = 'button';
          removeBtn.textContent = 'ì‚­ì œ';
          removeBtn.style.marginLeft = '8px';
          removeBtn.addEventListener('click', () => {
            li.remove();
          });

          li.appendChild(removeBtn);
          return li;
        }

        // ê¸°ì¡´ exerciseItems ë¥¼ ë¦¬ìŠ¤íŠ¸ì— ì±„ìš°ê¸°
        if (Array.isArray(exerciseItems) && exerciseItems.length > 0) {
          exerciseItems.forEach(item => {
            if (!item.exerciseId) return;
            const label = minutesToDurationLabel(item.minutes);
            if (!label) return;
            const found = exerciseList.find(ex => String(ex.id) === String(item.exerciseId));
            const name = found ? found.name : (item.name || 'ìš´ë™');
            const li = createEditExerciseLi(name, item.exerciseId, label);
            listEl.appendChild(li);
          });
        }

        // ì„¸ë¶€ì‚¬í•­ ì„¸íŒ…
        detailsTextarea.value = currentDetails || '';

        // ëª¨ë‹¬ ì•ˆì—ì„œ "í˜„ì¬ ì„ íƒ ìš´ë™ ì¶”ê°€"
        addBtn.addEventListener('click', () => {
          const exId    = exerciseSelect.value;
          const durLabel = durationSelect.value;
          if (!exId || !durLabel) {
            alert('ìš´ë™ê³¼ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
          }
          const found = exerciseList.find(ex => String(ex.id) === String(exId));
          const name = found ? found.name : 'ìš´ë™';
          const li = createEditExerciseLi(name, exId, durLabel);
          listEl.appendChild(li);
        });

        // ì €ì¥ ë²„íŠ¼
        saveBtn.addEventListener('click', async () => {
          const liNodes = listEl.querySelectorAll('li[data-exercise-id]');
          const exerciseIds = [];
          const durations   = [];

          liNodes.forEach(li => {
            exerciseIds.push(li.dataset.exerciseId);
            durations.push(li.dataset.duration);
          });

          if (exerciseIds.length === 0) {
            alert('ìš´ë™ì„ í•œ ê°œ ì´ìƒ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
            return;
          }

          const details = detailsTextarea.value;

          try {
            await fetch(`/health/${id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ exerciseIds, durations, details }),
            });
            wrapper.remove();
            location.reload();
          } catch (err) {
            console.error(err);
            alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        });

        // ì·¨ì†Œ ë²„íŠ¼
        cancelBtn.addEventListener('click', () => {
          wrapper.remove();
        });

        // ì˜¤ë²„ë ˆì´ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
        overlay.addEventListener('click', (evt) => {
          if (evt.target === overlay) {
            wrapper.remove();
          }
        });
      });
    });

    // ===== ìš´ë™ ê¸°ë¡ ì‚­ì œ ë²„íŠ¼ =====
    document.querySelectorAll('.deleteBtn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const div = e.target.closest('div[data-id]');
        const id  = div.dataset.id;

        if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
          await fetch(`/health/${id}`, {
            method: 'DELETE',
          });
          location.reload();
        } catch (err) {
          console.error(err);
          alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      });
    });

    // ===== ëŒ“ê¸€ ìˆ˜ì • ë²„íŠ¼ =====
    document.querySelectorAll('.commentEditBtn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const p         = e.target.closest('p[data-comment-id]');
        const commentId = p.dataset.commentId;
        const healthId  = p.dataset.healthId;
        const span      = p.querySelector('.commentText');
        const oldText   = span.textContent;

        const newComment = prompt('ëŒ“ê¸€ì„ ìˆ˜ì •í•˜ì„¸ìš”.', oldText);
        if (!newComment || newComment.trim() === '' || newComment === oldText) return;

        try {
          await fetch(`/health/${healthId}/comments/${commentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ comment: newComment }),
          });
          location.reload();
        } catch (err) {
          console.error(err);
          alert('ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      });
    });

    // ===== ëŒ“ê¸€ ì‚­ì œ ë²„íŠ¼ =====
    document.querySelectorAll('.commentDeleteBtn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const p         = e.target.closest('p[data-comment-id]');
        const commentId = p.dataset.commentId;
        const healthId  = p.dataset.healthId;

        if (!confirm('í•´ë‹¹ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
          await fetch(`/health/${healthId}/comments/${commentId}`, {
            method: 'DELETE',
          });
          location.reload();
        } catch (err) {
          console.error(err);
          alert('ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      });
    });
  </script>
</body>
</html>
