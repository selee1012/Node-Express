<!-- views/food.ejs -->
<!-- ê³ ê¸‰ì›¹í”„ë¡œê·¸ë˜ë° ê¸°ë§í”„ë¡œì íŠ¸ ì´ì„±ì€ 60212770 -->
<!-- ì‹ë‹¨ ë“±ë¡ í˜ì´ì§€ -->

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title><%= title %></title>
  <link rel="stylesheet" href="/frontUser.css" />
</head>
<body>
  <header><%- include('./header', { session: session }); %></header>

  <h2>ì‹ë‹¨ ë“±ë¡</h2>

  <form method="post" enctype="multipart/form-data" action="/food">
    <label>ì‹ì‚¬ ì¢…ë¥˜</label>
    <select name="meal_type">
      <option value="ì•„ì¹¨">ì•„ì¹¨</option>
      <option value="ì ì‹¬">ì ì‹¬</option>
      <option value="ì €ë…">ì €ë…</option>
      <option value="ê°„ì‹">ê°„ì‹</option>
    </select>
    <br />

    <label>ì‹ë‹¨ ì´ë¦„ (ì„ íƒ)</label>
    <input type="text" name="food_name" placeholder="ì˜ˆ: ìƒëŸ¬ë“œ, ì¹˜í‚¨ ë“±" />
    <br />

    <label>ì¹¼ë¡œë¦¬ (kcal)</label>
    <input
      type="number"
      name="calorie"
      step="1"
      min="0"
      placeholder="ì˜ˆ: 500"
      required
    />
    <br />

    <label>ì„­ì·¨ ë‚ ì§œ</label>
    <input type="date" name="date" />
    <br />

    <label>ì‹ë‹¨ ì´ë¯¸ì§€ (ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥)</label>
    <input type="file" name="images" multiple />

    <button type="submit">ë“±ë¡</button>
  </form>

  <!-- ğŸ”¹ ì˜¤ëŠ˜ ì„­ì·¨ ì¹¼ë¡œë¦¬ í‘œì‹œ -->
  <h3>ì˜¤ëŠ˜ ì„­ì·¨ ì¹¼ë¡œë¦¬</h3>
  <p>
    <strong><%= todayCalorie || 0 %></strong> kcal
  </p>

  <h3>ë“±ë¡ëœ ì‹ë‹¨ ëª©ë¡</h3>
  <div id="foodList">
    <% foods.forEach(f => { %>
      <div
        data-id="<%= f.id %>"
        data-meal-type="<%= f.meal_type %>"
        data-calorie="<%= f.calorie %>"
        data-date="<%= f.date %>"
        style="border: 1px solid #ccc; margin: 10px; padding: 10px;"
      >
        <p>[<%= f.date %>] <strong><%= f.meal_type %></strong></p>

        <p>ì¹¼ë¡œë¦¬: <strong><%= f.calorie %></strong> kcal</p>

        <!-- ì—¬ëŸ¬ ì¥ í‘œì‹œ -->
        <% if (f.imagePaths && f.imagePaths.length > 0) { %>
          <% f.imagePaths.forEach(img => { %>
            <img src="<%= img %>" width="150" style="margin-right: 8px;" />
          <% }) %>
        <% } %>

        <br/><br/>
        <button class="editBtn">ìˆ˜ì •</button>
        <button class="deleteBtn">ì‚­ì œ</button>
      </div>
    <% }) %>
  </div>

  <footer><%- include('./footer'); %></footer>

  <script>
  // ===== ì‹ë‹¨ ìˆ˜ì • ë²„íŠ¼ (ì‹ì‚¬ ì¢…ë¥˜: ì„ íƒ, ì¹¼ë¡œë¦¬: ì…ë ¥) =====
  document.querySelectorAll('#foodList .editBtn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const div = e.target.closest('div[data-id]');
      const id = div.dataset.id;

      const currentMealType = div.dataset.mealType || 'ì•„ì¹¨';
      const currentCalorie  = div.dataset.calorie || '0';

      // ëª¨ë‹¬ ìƒì„±
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <div class="edit-food-modal-overlay"
             style="
               position: fixed;
               inset: 0;
               background: rgba(0,0,0,0.4);
               display: flex;
               align-items: center;
               justify-content: center;
               z-index: 9999;
             ">
          <div class="edit-food-modal"
               style="
                 background: #fff;
                 padding: 16px;
                 border-radius: 8px;
                 width: 90%;
                 max-width: 360px;
                 box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                 font-size: 14px;
               ">
            <h3 style="margin-top: 0; margin-bottom: 12px;">ì‹ë‹¨ ìˆ˜ì •</h3>

            <div style="margin-bottom: 8px;">
              <label style="display:block; margin-bottom:4px;">ì‹ì‚¬ ì¢…ë¥˜</label>
              <select class="edit-meal-type" style="width:100%; padding:4px 8px;">
                <option value="ì•„ì¹¨">ì•„ì¹¨</option>
                <option value="ì ì‹¬">ì ì‹¬</option>
                <option value="ì €ë…">ì €ë…</option>
                <option value="ê°„ì‹">ê°„ì‹</option>
              </select>
            </div>

            <div style="margin-bottom: 12px;">
              <label style="display:block; margin-bottom:4px;">ì¹¼ë¡œë¦¬ (kcal)</label>
              <input
                type="number"
                class="edit-calorie-input"
                min="0"
                step="1"
                style="width:100%; padding:4px 8px;"
              />
            </div>

            <div style="text-align: right;">
              <button type="button" class="cancelEditBtn"
                      style="margin-right: 8px;">ì·¨ì†Œ</button>
              <button type="button" class="saveEditBtn">ì €ì¥</button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(wrapper);

      const overlay      = wrapper.querySelector('.edit-food-modal-overlay');
      const modal        = wrapper.querySelector('.edit-food-modal');
      const mealSelect   = modal.querySelector('.edit-meal-type');
      const calorieInput = modal.querySelector('.edit-calorie-input');

      // í˜„ì¬ ê°’ ì„¸íŒ…
      Array.from(mealSelect.options).forEach(opt => {
        if (opt.value === currentMealType || opt.textContent.trim() === currentMealType.trim()) {
          opt.selected = true;
        }
      });
      calorieInput.value = currentCalorie;

      // ì·¨ì†Œ
      modal.querySelector('.cancelEditBtn').addEventListener('click', () => {
        wrapper.remove();
      });

      // ì €ì¥
      modal.querySelector('.saveEditBtn').addEventListener('click', async () => {
        const meal_type = mealSelect.value;
        const newCalorie = calorieInput.value;

        if (!meal_type) {
          alert('ì‹ì‚¬ ì¢…ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        if (newCalorie === '' || Number(newCalorie) < 0) {
          alert('ì¹¼ë¡œë¦¬ë¥¼ 0 ì´ìƒìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        await fetch(`/food/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            meal_type,
            calorie: newCalorie
          })
        });

        wrapper.remove();
        // ì„œë²„ì—ì„œ ì¬ê³„ì‚°í•˜ê³  ìˆìœ¼ë¯€ë¡œ ìƒˆë¡œê³ ì¹¨í•˜ë©´
        // ì˜¤ëŠ˜ ì„­ì·¨ ì¹¼ë¡œë¦¬ + ëª©ë¡ ì¹¼ë¡œë¦¬ê°€ ìë™ìœ¼ë¡œ ê°±ì‹ ë¨
        location.reload();
      });

      // ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
      overlay.addEventListener('click', (evt) => {
        if (evt.target === overlay) {
          wrapper.remove();
        }
      });
    });
  });

  // ===== ì‹ë‹¨ ì‚­ì œ ë²„íŠ¼ =====
  document.querySelectorAll('#foodList .deleteBtn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const div = e.target.closest('div[data-id]');
      const id = div.dataset.id;

      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      await fetch(`/food/${id}`, { method: 'DELETE' });

      // ì‚­ì œ ì‹œì—ë„ ì„œë²„ ìª½ì—ì„œ ì˜¤ëŠ˜ ì¹¼ë¡œë¦¬ ì¬ê³„ì‚° ìˆ˜í–‰ ì¤‘ì´ë¯€ë¡œ,
      // ìƒˆë¡œê³ ì¹¨í•˜ë©´ food í˜ì´ì§€ "ì˜¤ëŠ˜ ì„­ì·¨ ì¹¼ë¡œë¦¬" + health ì¹¼ë¡œë¦¬ ë‘˜ ë‹¤ ë°˜ì˜ë¨
      location.reload();
    });
  });
  </script>
</body>
</html>
